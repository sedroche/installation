---
# tasks file for integration-controller
- name: Check if integration custom resource definition exists
  shell: oc get crd {{ integration_crd_name }} -n {{ integration_namespace }}
  register: integration_crd_exist
  failed_when: false

- name: Create integration custom resource definition
  shell: oc create -f {{ integration_crd_url }} --namespace {{ integration_namespace }}
  when: integration_crd_exist.rc != 0

#check for this needed
- name: Create RBAC for the managed services broker
  shell: oc create -f {{ integration_rbac_url }} -n {{ integration_namespace }}
  # need to remove this when the checks are in
  failed_when: false

- name: Check if integration controller deployment exists
  shell: oc get deploy {{ integration_deployment_name }} -n {{ integration_namespace }}
  register: integration_controller_deployment_exist
  failed_when: false

- block:
  -
    name: Create integration controller deployment
    shell: oc create -f {{ integration_deployment_url }} --namespace {{ integration_namespace }}

  -
    name: Verify integration controller deployment succeeded
    shell: sleep 5; oc get pods --namespace {{ integration_namespace }}  |  grep  "deploy"
    register: result
    until: not result.stdout
    retries: 50
    delay: 10
    failed_when: result.stdout
    changed_when: False
  when: integration_controller_deployment_exist.rc != 0
